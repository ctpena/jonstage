---
import Layout from "../../layouts/Layout.astro";
import {getCollection, render} from 'astro:content';

const diaryEntries = await getCollection('diary');
diaryEntries.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// 年のリストを取得
const years = [...new Set(diaryEntries.map(entry => entry.data.date.getFullYear()))].sort((a, b) => b - a);

// 最新50件のみを表示
const latestEntries = diaryEntries.slice(0, 50);

// 全コンテンツを表示するために、各エントリーをレンダーする
const entriesWithContent = await Promise.all(
    latestEntries.map(async (entry) => {
        const {Content} = await render(entry);
        return {entry, Content};
    })
);

const formatDate = (date: Date) => {
    return date.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
    });
};

const itemListData = {
    items: latestEntries.map(entry => ({
        url: `/diary/${entry.data.date.toISOString().split('T')[0]}/`
    }))
};

const breadcrumbs = [
    { name: '劇団員日記', item: '/diary/' }
];
---

<Layout 
    title="劇団員日記" 
    description="2006年から劇団員が書いてきた日記、各公演の様子や裏話、関西大学総合情報学部の日常などを綴っています。"
    schemaType="ItemList"
    schemaData={itemListData}
    breadcrumbs={breadcrumbs}
>
    <main>
        <section class="container-md mt-5">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a class="breadcrumb-link" href="/">ホーム</a></li>
                <li class="breadcrumb-item">劇団員日記</li>
            </ol>
            <h1 class="h1">劇団員日記</h1>
            <ul class="utilitylink-units mt-3 flex-wrap">
                {years.map(year => (
                        <li class="utilitylink-item">
                            <a href={`/diary/${year}/`} class="utilitylink">{year}年</a>
                        </li>
                ))}
            </ul>
            <p class="text-right">最新50件 / 全{diaryEntries.length}件</p>
        </section>
        <section class="container-sm mt-4 vstack g-5">
            {entriesWithContent.map(({entry, Content}) => (
                    <article class="">
                        <h2 class="h2 mb-3">
                            <a class="link"
                               href={`/diary/${entry.data.date.toISOString().split('T')[0]}/`}>{entry.data.title}</a>
                        </h2>
                        <time class="" datetime={entry.data.date.toISOString()}>{formatDate(entry.data.date)}</time>
                        <div class="mt-3 content">
                            <Content/>
                        </div>
                        <hr class="mt-3 divider w-25">
                    </article>
            ))}
        </section>
    </main>
</Layout>
