---
import Layout from "../../layouts/Layout.astro";
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";

export async function getStaticPaths() {
    const pastPerformances = await getCollection("pastPerformancesCollection");

    // Sort performances by date (newest first)
    const sortedPerformances = [...pastPerformances].sort(
        (a, b) => b.data.date.getTime() - a.data.date.getTime(),
    );

    return sortedPerformances.map((entry, index) => {
        // Get previous and next performances
        const prevPerformance = sortedPerformances[index - 1];
        const nextPerformance = sortedPerformances[index + 1];

        return {
            params: { slug: entry.id },
            props: {
                entry,
                prevPerformance: prevPerformance
                    ? {
                          id: prevPerformance.id,
                          title: prevPerformance.data.title,
                      }
                    : null,
                nextPerformance: nextPerformance
                    ? {
                          id: nextPerformance.id,
                          title: nextPerformance.data.title,
                      }
                    : null,
            },
        };
    });
}

const { entry, prevPerformance, nextPerformance } = Astro.props;
const { Content } = await render(entry);

// Format the date
const performanceDate = entry.data.date.toLocaleDateString("ja-JP", {
    year: "numeric",
    month: "long",
    day: "numeric",
});
---

<Layout
    title={`${entry.data.title} | 劇団万絵巻`}
    description={`${entry.data.title} - ${entry.data.excerpt}. 脚本: ${entry.data.playwright}, 演出: ${entry.data.director}`}
    image={entry.data.image ? entry.data.image.src : undefined}
>
    <main class="container-sm">
        <article class="mt-5">
            <header class="">
                <nav>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a class="breadcrumb-link" href="/">ホーム</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a
                                class="breadcrumb-link"
                                href="/past-performances/">過去公演</a
                            >
                        </li>
                        <li class="breadcrumb-item active">
                            {entry.data.title}
                        </li>
                    </ol>
                </nav>
                <h1 class="h1 my-3">{entry.data.title}</h1>
                <div class="">
                    <span class="">{performanceDate}</span>
                    <span class="">演出: {entry.data.director}</span>
                    <span class="">脚本: {entry.data.playwright}</span>
                </div>
            </header>
            <div class="mt-3">
                {
                    entry.data.image && (
                        <Image
                            src={entry.data.image}
                            alt={entry.data.title}
                            width={1200}
                            height={600}
                            class="featured-image"
                        />
                    )
                }
            </div>
            <div class="content">
                <Content />
            </div>
        </article>
        <div class="mt-6">
            <div class="hstack g-4 justify-between">
                <span>←前の公演</span>
                <span>次の公演→</span>
            </div>
            <div class="hstack g-4 justify-between mt-3">
                {
                    nextPerformance && (
                        <a
                            href={`/past-performances/${nextPerformance.id}/`}
                            class="btn"
                        >
                            <span class="">{nextPerformance.title}</span>
                        </a>
                    )
                }
                <a href="/past-performances/" class="btn">過去公演一覧に戻る</a>
                {
                    prevPerformance && (
                        <a
                            href={`/past-performances/${prevPerformance.id}/`}
                            class="btn"
                        >
                            <span class="">{prevPerformance.title}</span>
                        </a>
                    )
                }
            </div>
        </div>
    </main>
</Layout>

<style>
    .featured-image {
        width: 100%;
        height: auto;
        border-radius: 8px;
        object-fit: cover;
    }
</style>
