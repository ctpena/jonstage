---
import {Image} from 'astro:assets';
import {getCollection, type CollectionEntry} from 'astro:content';
import Layout from '../../layouts/Layout.astro';

const allPerformances = await getCollection('performances');

const sortedPerformances = allPerformances.sort((a: CollectionEntry<'performances'>, b: CollectionEntry<'performances'>) => {
    return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

const performancesByYear = sortedPerformances.reduce((acc: Record<number, CollectionEntry<'performances'>[]>, performance: CollectionEntry<'performances'>) => {
    const date = new Date(performance.data.date);
    const year = date.getFullYear();
    if (!acc[year]) {
        acc[year] = [];
    }
    acc[year].push(performance);
    return acc;
}, {} as Record<number, CollectionEntry<'performances'>[]>);

const years = Object.keys(performancesByYear).map(Number).sort((a: number, b: number) => b - a);

const itemListData = {
    items: sortedPerformances.map(p => ({
        url: `/performances/${p.id}/`
    }))
};

const breadcrumbs = [
    { name: '公演', item: '/performances/' }
];
---

<Layout
    title="公演"
    description="劇団万絵巻の過去から現在までの公演一覧です。1994年の設立以来、様々な作品を上演してきました。"
    schemaType="ItemList"
    schemaData={itemListData}
    breadcrumbs={breadcrumbs}
>
    <main>
        <section class="container-md mt-5">
            <h1 class="h1">公演</h1>
        </section>
        {years.map((year: number) => (
                <section class="container-md mt-4">
                    <h2 id={year.toString()} class="h2">{year}年</h2>
                    <div class="mt-3 vstack g-4">
                        {performancesByYear[year].map((performance: CollectionEntry<'performances'>) => (
                                <article class="custom-card">
                                    <div class="custom-card__data">
                                        <h3 class="h2">{performance.data.title}</h3>
                                        <time datetime={new Date(performance.data.date).toISOString().split('T')[0]}>
                                            {new Date(performance.data.date).toLocaleDateString('ja-JP', {
                                                year: 'numeric',
                                                month: 'long',
                                                day: 'numeric'
                                            })}
                                        </time>
                                        <p>{performance.data.excerpt}</p>
                                        <div class="hstack g-3">
                                            <ul>
                                                <li>作：{performance.data.playwright}</li>
                                                <li>演出：{performance.data.director}</li>
                                            </ul>
                                        </div>
                                        <a class="btn btn-fill is-sm"
                                           href={`/performances/${performance.id}/`}>詳しくみる</a>
                                    </div>
                                    <div class="custom-card__img-area">
                                        <Image class="custom-card__img" src={performance.data.image}
                                               alt={performance.data.title}/>
                                    </div>
                                </article>
                        ))}
                    </div>
                </section>
        ))}

        <section class="bg-grey-100 py-6 mt-6">
            <div class="container-sm">
                <h2 class="h2 mb-3">私たちの公演の歴史</h2>
                <p class="mb-3">
                    1994年の劇団設立以来、古典的な作品から現代的な作品まで、様々な舞台を制作してきました。このアーカイブは、多様なストーリーテリングと芸術的な卓越性への私たちの取り組みを表しています。
                </p>
                <p class="">
                    公演履歴の詳細情報や、研究目的のためのアーカイブ資料のリクエストについては、
                    <a href="/contact/" class="link">お問い合わせ</a>ください。
                </p>
            </div>
        </section>
    </main>
</Layout>

<style lang="scss">
  .custom-card {
    border: 1px solid #949494;
    display: grid;
    grid-template-columns: .4fr 1fr;
    grid-template-rows: auto;
    grid-template-areas: "img data";

    &__img-area {
      grid-area: img;
      border-right: 1px solid #949494;
    }

    &__img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    &__data {
      padding: 1rem 1.5rem;
      grid-area: data;
      display: flex;
      flex-direction: column;
      gap: .5rem;
    }
  }
</style>
